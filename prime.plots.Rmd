---
  title: "EHV-1 Genes' transcript ratios"
author: Bal√°zs Kakuk
output:
  html_document:
  theme: cosmo
toc: yes
toc_float:
  collapsed: false
---

  ```{css, echo=FALSE}
body .main-container {
  max-width: 90% !important;
  width: 90% !important;
}
body {
  max-width: 90% !important;
  margin-left: auto;
  margin-right: auto;
}
```


```{r include=FALSE}
## hrbrthemes::ipsum:

knitr::opts_chunk$set(fig.retina=2, echo = FALSE, fig.align = 'center', message = F, warning = F)
```

```{r ipsum_setup, message=FALSE, warning=FALSE, cache=FALSE, echo=FALSE}
library(prettydoc)
library(hrbrthemes, quietly = T)
#library(GenomicFeatures, quietly = T)
library(DESeq2, quietly = T)
library(ggpubr, quietly = T)
#library(misc, quietly = T)
library(dplyr, quietly = T)
#library(tidyverse, quietly = T)
library(ggsci, quietly = T)
#library(Gviz, quietly = T)
library(dplyr, quietly = T)
library(tidyr)
library(scales)
#library(plyr)
library(grid, quietly = T)
library(gridExtra, quietly = T)
library(ggpubr, quietly = T)
library(data.table)
library(ggh4x)
library(knitr)
library(formattable)
library(ggrepel)
library(utils)

#library(moanin, quietly = T)
#library(stageR); library(edgeR) ; library(Biobase)
#library(limma) ; library(DEXSeq)

dontrun <- T
source('customclust.R')
source('mclust.R')


###
viral.ref <- "NC_001491.2.mRNA_corrected.v3.gff3"
source('_WF.part0.R')

#### Settings ####

## Main
colorvec <- na.omit(c(
  colorvec[c(1:5,15,13,10,24,7,26,32,33)],
  colorvec[-c(1:5,15,13,10,24,7,26,32,33)]))

colorvec <- colorvec[-c(9,13)]


colorvec <- colorvec[-c(10,13,17,18)]

colorvec <- colorvec[c(1:2,14,3:length(colorvec))]


palette  <- colorvec #pal_npg()(10)

writetables <- T
```


```{r}

## prime5 plots
EndType <- 'prime.plots'

project_config  <- fread('project_config.txt')
outdir  <- project_config$outdir
res.dir <- outdir; try({ dir.create(res.dir) })
fig.dir <- paste0(res.dir, '/', EndType); try({ dir.create(fig.dir) })## save plots to this directory
#
```



```{r}
##### START PLOTTING FROM HERE
#cov.counts    <- fread(paste0(outdir, '/cov.counts.tsv'),    na.strings = '')

## read back in
prime5.counts <- fread(paste0(outdir, '/prime5.counts.tsv'), na.strings = '')
prime3.counts <- fread(paste0(outdir, '/prime3.counts.tsv'), na.strings = '')



## filter now
correct.only <- T
if(correct.only) {
  prime5.counts <- prime5.counts[correct_tss == T,]
  prime3.counts <- prime3.counts[correct_tes == T,]
}


### normalize for viral read counts?
## based on correct adaptered-only
norm <- F
if(norm) {
  colsby <- colnames(prime5.counts)[!colnames(prime5.counts) %in% c('pos', 'start', 'end', 'prime5', 'count')]
  prime5.counts[, sum_count := sum(count), by=colsby]
  prime5.counts[, count     := round((count/ sum_count) * 100, 3)]
  prime5.counts[, .(sum_count = sum(count)), by=colsby]
  prime5.counts[, sum_count := NULL]

  colsby <- colnames(prime3.counts)[!colnames(prime3.counts) %in% c('pos', 'start', 'end', 'prime3', 'count')]
  prime3.counts[, sum_count := sum(count), by=colsby]
  prime3.counts[, count     := round((count/ sum_count) * 100, 3)]
  prime3.counts[, .(sum_count = sum(count)), by=colsby]
  prime3.counts[, sum_count := NULL]

}

## check if all the samples have the same library size
all(round(prime5.counts[,.(sum_count = (sum(count))), by=.(sample)][,sum_count], 0) == 1)


##calculate the mean? otherwise, the plot will SUM the counts based on the "group" column
calc.mean <- F
##
if(calc.mean) {
  prime3.counts <- prime3.counts[,.(count = round(mean(count), 2)), by=.(seqnames, strand, pos, correct_tes, hpi, Time, cell_line, group, endtype)]
  prime5.counts <- prime5.counts[,.(count = round(mean(count), 2)), by=.(seqnames, strand, pos, correct_tss, hpi, Time, cell_line, group, endtype)]

  #prime5.counts <- unique(prime5.counts[,.(seqnames, strand, pos, correct_tss, count, hpi, Time, cell_line, group, endtype)])
  #prime3.counts <- unique(prime3.counts[,.(seqnames, strand, pos, correct_tes, count, hpi, Time, cell_line, group, endtype)])

}

##
prime5.counts[,prime5 := pos][,prime5 := NULL]
prime3.counts[,prime3 := pos][,prime3 := NULL]

##### plotting settings

##
plot.all.together <- T

## grouping
combine.groups <- 'hpi' ## 'sample' ## OR:

## adapter settings
adapter.setting <- 'v4'

##
tolower_gene_name <- F
```


```{r}
######## REVIEW

#### Normalized
file_name_suffix <- 'Mean_correct_norm'
##
ylim       <- NULL #c(0, 50) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'Figure 1B_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)
#ggsave(paste0(fig.dir, '/', 'Figure 1B_REVIEW_ori.tif'), plot = FigY, height = 20, width = 36, limitsize = F, dpi=300)
Fig1B <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

Fig2B <- Fig2

ggsave(paste0(fig.dir, '/', 'Figure 2B_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)



#### ylim 0-500
file_name_suffix <- 'Mean_correct_ylim500'
##
ylim       <- c(0, 500) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'Figure 1A_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig1A <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

ggsave(paste0(fig.dir, '/', 'Figure 2A_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig2A <- Fig2




#### ylim 0-50
file_name_suffix <- 'Mean_correct_norm'
##
ylim       <- c(0, 50) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 1B_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)
#ggsave(paste0(fig.dir, '/', 'Figure 1B_REVIEW_ori.tif'), plot = FigY, height = 20, width = 36, limitsize = F, dpi=300)
Fig1B <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

Fig2B <- Fig2

ggsave(paste0(fig.dir, '/', 'SuppFig 2B_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)


#### ylim 0-5000
file_name_suffix <- 'Mean_correct_ylim500'
##
ylim       <- c(0, 5000) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 1A_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig1A <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 2A_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig2A <- Fig2




######### ORIGINAL

#### 0-5000
file_name_suffix <- 'Mean_correct_norm'
##
ylim       <- c(0, 5000) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 1C_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)
#ggsave(paste0(fig.dir, '/', 'Figure 1B_REVIEW_ori.tif'), plot = FigY, height = 20, width = 36, limitsize = F, dpi=300)
Fig1B <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

Fig2B <- Fig2

ggsave(paste0(fig.dir, '/', 'SuppFig 2C_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)


#### ylim500
file_name_suffix <- 'Mean_correct_ylim500'
##
ylim       <- c(0, 500) # c(-1000, 1000)

## prime5
source('plot_prime5_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime5.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 1D_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig1A <- Fig1


## prime3
source('plot_prime3_area_settings.R')
fig.dir <- 'Figures' # '../EHV-1 dynamic article/Review 2024 nov'
source('plot_prime3.R')

ggsave(paste0(fig.dir, '/', 'SuppFig 2D_REVIEW.jpg'), plot = FigY, height = 20, width = 30, limitsize = F, dpi=300)

Fig2A <- Fig2



```

















